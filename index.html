<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sprachlern-App</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; background:#f0f6ff; margin:0; color:#1f2d3d; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1 { margin: 10px 0; }
    .card { background:white; border-radius:18px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; }
    button { font-size: 18px; padding: 12px 14px; border-radius:14px; border:1px solid #d7e3ff; background:#fff; cursor:pointer; }
    button.primary { background:#2d7ff9; color:#fff; border:none; font-weight:800; }
    button.gray { background:#eef3ff; border:1px solid #d7e3ff; font-weight:800; }
    button.danger { background:#ffecec; border:1px solid #ffb6b6; font-weight:900; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef3ff; font-weight:700; }
    .hidden { display:none; }
    .q { font-size: 26px; margin: 10px 0 8px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    select, input { font-size: 18px; padding: 10px 12px; border-radius:12px; border:1px solid #d7e3ff; width: min(520px, 100%); }
    .choices { display:flex; gap:12px; flex-wrap:wrap; margin-top: 12px; }
    .choice { background:#4CAF50; color:white; border:none; font-weight:900; min-width: 180px; }
    .choice:disabled { opacity:.6; }
    .feedback { font-size: 20px; font-weight:900; margin-top: 10px; min-height: 28px; }
    .score { margin-top: 6px; font-size: 18px; }
    .hr { height:1px; background:#e8efff; margin: 14px 0; }
    .small { font-size: 14px; opacity:.85; line-height: 1.35; }

    /* Grammatik: feste Buttonfarben */
    .g-yellow { background:#f1c40f !important; color:#1f2d3d !important; }
    .g-blue   { background:#2d7ff9 !important; color:white !important; }
    .g-green  { background:#4CAF50 !important; color:white !important; }

    /* Progressbar */
    .progress {
      width: 100%;
      max-width: 760px;
      height: 14px;
      background: #eef3ff;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #d7e3ff;
      margin-top: 10px;
    }
    .progress > div {
      height: 100%;
      width: 0%;
      background: #2d7ff9;
    }

    /* Lehrer-Checkliste */
    .checkgrid { display:grid; gap:8px; margin-top: 8px; }
    .checkrow { display:flex; gap:10px; align-items:center; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#eef3ff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>ğŸŒ Sprachlern-App</h1>
      <div>
        <span class="pill" id="modePill">Start</span>
        <button class="gray" id="homeBtn" onclick="showView('home')" style="display:none;">ğŸ  Startseite</button>
      </div>
    </div>

    <!-- Lehrer-Panel -->
    <details class="card" style="margin:12px 0; box-shadow:none; border:1px solid #e8efff;">
      <summary style="cursor:pointer; font-weight:900;">ğŸ§‘â€ğŸ« Lehrer-Panel</summary>

      <div class="small" style="margin-top:10px;">
        <strong>Freischaltung (nur auf diesem GerÃ¤t gespeichert):</strong><br>
        SchÃ¼ler sehen nur die freigeschalteten Themen in den Dropdowns.
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="gray" id="tp_load_online">Dateien online laden (manifest.csv)</button>
        <button class="gray" id="tp_use_builtin">Eingebaute Themen nutzen</button>
        <button class="gray" id="tp_select_all">Alle erlauben</button>
        <button class="gray" id="tp_select_none">Alle sperren</button>
        <button class="primary" id="tp_apply">Speichern</button>
      </div>

      <div id="tp_status" class="small" style="margin-top:8px;">Status: â€”</div>

      <div class="hr"></div>
      <div class="small">
        <strong>Themenliste</strong> (HÃ¤kchen = freigeschaltet):
      </div>
      <div id="tp_list" class="small">Noch nicht geladen.</div>

      <div class="hr"></div>
      <div class="row">
        <button class="danger" id="tp_reset_storage">Freischaltung zurÃ¼cksetzen</button>
        <button class="gray" id="tp_go_home">Zur Startseite</button>
      </div>

      <div class="small" style="margin-top:10px;">
        <strong>SpÃ¤ter</strong>: Lege im GitHub-Repo einen Ordner <code>data/</code> an und eine Datei
        <code>data/manifest.csv</code>. Dann lÃ¤dt der Button â€Dateien online ladenâ€œ alles automatisch.
      </div>
    </details>

    <!-- HOME -->
    <div id="home" class="card">
      <h2 style="margin-top:0;">WÃ¤hle ein Lernmodul</h2>
      <div class="grid">
        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>ğŸ§  Vokabel-Quiz</h3>
          <p>Multiple Choice, Punkte, Themen.</p>
          <button class="primary" onclick="showView('vocab')">Start</button>
        </div>

        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>ğŸ§© Grammatik-Quiz</h3>
          <p>Multiple Choice, ErklÃ¤rung, Themen.</p>
          <button class="primary" onclick="showView('grammar')">Start</button>
        </div>

        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>âœï¸ LÃ¼ckentext</h3>
          <p>Antworten eintippen (kommagetrennt).</p>
          <button class="primary" onclick="showView('cloze')">Start</button>
        </div>
      </div>
    </div>

    <!-- VOCAB QUIZ -->
    <div id="vocab" class="card hidden">
      <h2 style="margin-top:0;">ğŸ§  Vokabel-Quiz</h2>

      <div class="row">
        <label style="font-size:18px; font-weight:800;">Thema:</label>
        <select id="v_thema"></select>
        <button class="primary" id="v_start">Start / Neustart</button>
      </div>

      <div class="small" style="margin-top:6px;">
        (Optional) Vokabeldatei direkt vom GerÃ¤t laden:
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="v_file" type="file" accept=".csv,.txt" />
        <button class="gray" id="v_load">Datei laden</button>
        <span class="small">Format: de;en (oder de,en)</span>
      </div>

      <div class="q" id="v_frage">WÃ¤hle ein Thema und klicke Start.</div>
      <div class="progress"><div id="v_prog"></div></div>

      <div class="choices">
        <button class="choice" id="v_b0" disabled>â€”</button>
        <button class="choice" id="v_b1" disabled>â€”</button>
        <button class="choice" id="v_b2" disabled>â€”</button>
      </div>

      <div class="feedback" id="v_feedback"></div>
      <div class="score" id="v_score">Punkte: 0/0</div>
    </div>

    <!-- GRAMMAR QUIZ -->
    <div id="grammar" class="card hidden">
      <h2 style="margin-top:0;">ğŸ§© Grammatik-Quiz</h2>

      <div class="row" style="margin-top:10px;">
        <label style="font-weight:800;">Thema:</label>
        <select id="g_thema"></select>
        <button class="gray" id="g_load_online">Thema laden</button>
        <button class="primary" id="g_start">Quiz starten</button>
      </div>

      <div class="small" style="margin-top:6px;">
        (Optional) Grammatikdatei direkt vom GerÃ¤t laden:
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="g_file" type="file" accept=".csv,.txt" />
        <button class="gray" id="g_load_local">Datei laden</button>
        <span class="small">Format: frage;richtig;falsch1;falsch2;optional erklÃ¤rung</span>
      </div>

      <div class="q" id="g_frage">WÃ¤hle ein Thema â†’ â€Thema ladenâ€œ â†’ â€Quiz startenâ€œ.</div>
      <div class="progress"><div id="g_prog"></div></div>

      <div class="choices">
        <button class="choice g-yellow" id="g_b0" disabled>â€”</button>
        <button class="choice g-blue"  id="g_b1" disabled>â€”</button>
        <button class="choice g-green" id="g_b2" disabled>â€”</button>
      </div>

      <div class="feedback" id="g_feedback"></div>
      <div class="score" id="g_score">Punkte: 0/0</div>

      <div class="card" style="box-shadow:none; border:1px solid #e8efff; background:#fff; margin-top:10px;">
        <div class="small" style="margin-bottom:6px;"><strong>ğŸ’¡ ErklÃ¤rung</strong></div>
        <div id="g_explain" style="font-size:18px; line-height:1.35;">â€”</div>
      </div>
    </div>

    <!-- CLOZE -->
    <div id="cloze" class="card hidden">
      <h2 style="margin-top:0;">âœï¸ LÃ¼ckentext</h2>

      <div class="row">
        <span class="pill">LÃ¼ckentext</span>
        <button class="primary" id="c_new">Neue Aufgabe</button>
        <button class="gray" id="c_check">PrÃ¼fen</button>
      </div>

      <div class="hr"></div>

      <div class="q" id="c_title">Klicke â€Neue Aufgabeâ€œ.</div>

      <div style="margin-top:10px;">
        <div class="small">Text (mit LÃ¼cken als ____):</div>
        <div class="card" style="box-shadow:none; border:1px solid #e8efff; background:#fff;">
          <div id="c_text" style="font-size:22px; line-height:1.4;">â€”</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Deine Einsetzung (kommagetrennt, z. B. â€der, ins, habeâ€œ):</div>
        <input id="c_input" placeholder="Antworten hier eintippenâ€¦" />
      </div>

      <div class="feedback" id="c_feedback"></div>
    </div>
  </div>

<script>
  // -----------------------------
  // NAVIGATION
  // -----------------------------
  function showView(id){
    ["home","vocab","grammar","cloze"].forEach(v => document.getElementById(v).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.getElementById("homeBtn").style.display = (id === "home") ? "none" : "inline-block";
    document.getElementById("modePill").textContent =
      id === "home" ? "Start" :
      id === "vocab" ? "Vokabel-Quiz" :
      id === "grammar" ? "Grammatik-Quiz" : "LÃ¼ckentext";
  }

  // -----------------------------
  // Helpers
  // -----------------------------
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }
  function setButtons(btns, disabled){
    btns.forEach(b => b.disabled = disabled);
  }

  async function fetchText(path){
    const res = await fetch(path, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }

  function parseCSVLineSmart(line){
    // FÃ¼r unseren Zweck: simple Split (Semikolon bevorzugt, dann Komma, dann TAB)
    let parts = line.split(";");
    if(parts.length < 2) parts = line.split(",");
    if(parts.length < 2) parts = line.split("\t");
    return parts.map(p => p.trim());
  }

  // -----------------------------
  // Default-Manifest (lÃ¤uft sofort, ohne Ordner)
  // -----------------------------
  const MANIFEST_BUILTIN = [
    // typ, titel, source, path
    // source: "builtin" -> Daten sind eingebaut
    // source: "remote"  -> CSV liegt online (path)
    { typ: "vokabel",   titel: "Tiere (eingebaut)",     source: "builtin", path: "builtin:vok_tiere" },
    { typ: "vokabel",   titel: "Schule (eingebaut)",    source: "builtin", path: "builtin:vok_schule" },
    { typ: "grammatik", titel: "Artikel (eingebaut)",   source: "builtin", path: "builtin:gram_artikel" },
    { typ: "grammatik", titel: "PrÃ¤positionen (eingebaut)", source: "builtin", path: "builtin:gram_praep" },
  ];

  // Eingebaute Inhalte (damit sofort alles funktioniert)
  const BUILTIN = {
    vok_tiere: [
      ["Hund","dog"], ["Katze","cat"], ["Vogel","bird"], ["Pferd","horse"], ["Maus","mouse"]
    ],
    vok_schule: [
      ["Schule","school"], ["Buch","book"], ["Stift","pen"], ["Tafel","board"], ["Lehrer","teacher"]
    ],
    gram_artikel: [
      ["WÃ¤hle den Artikel: ___ Hund", "der", "die", "das", "Maskulin: der Hund"],
      ["WÃ¤hle den Artikel: ___ Katze", "die", "der", "das", "Feminin: die Katze"],
      ["WÃ¤hle den Artikel: ___ Haus", "das", "der", "die", "Neutrum: das Haus"],
    ],
    gram_praep: [
      ["Ich gehe ___ Schule. (zu + der)", "zur", "zu", "in", "â€zurâ€œ = zu + der (Dativ)"],
      ["Ich bin ___ Schule.", "in der", "in die", "zur", "Ort: in der (Dativ)"],
      ["Ich gehe ___ Park.", "in den", "im", "zum", "Richtung: in den (Akkusativ)"],
    ]
  };

  // -----------------------------
  // Manifest + Freischaltung (nur LehrergerÃ¤t)
  // -----------------------------
  let MANIFEST = [];            // Array von {typ, titel, source, path}
  let ENABLED = new Set();      // Set of path strings
  const LS_ENABLED = "enabled_files_v1";
  const LS_MANIFEST_MODE = "manifest_mode_v1"; // "builtin" oder "online"

  function loadEnabled(){
    try {
      const raw = localStorage.getItem(LS_ENABLED);
      if(!raw) return;
      const arr = JSON.parse(raw);
      ENABLED = new Set(arr);
    } catch(e) {}
  }
  function saveEnabled(){
    localStorage.setItem(LS_ENABLED, JSON.stringify([...ENABLED]));
  }

  function setStatus(msg){
    document.getElementById("tp_status").textContent = "Status: " + msg;
  }

  function renderTeacherList(){
    const box = document.getElementById("tp_list");
    if(!MANIFEST.length){
      box.textContent = "Keine Themen verfÃ¼gbar.";
      return;
    }

    const groups = { vokabel: [], grammatik: [] };
    MANIFEST.forEach(it => (groups[it.typ] ??= []).push(it));

    let html = "";
    for(const typ of ["vokabel","grammatik"]){
      const items = groups[typ] || [];
      if(!items.length) continue;

      html += `<div style="margin-top:10px;"><strong>${typ.toUpperCase()}</strong></div>`;
      html += `<div class="checkgrid">`;
      for(const it of items){
        const checked = ENABLED.has(it.path) ? "checked" : "";
        const tag = it.source === "remote" ? "online" : "eingebaut";
        html += `
          <label class="checkrow">
            <input type="checkbox" data-path="${it.path}" ${checked} />
            <span>${it.titel} <span class="tag">${tag}</span></span>
          </label>`;
      }
      html += `</div>`;
    }
    box.innerHTML = html;
  }

  function ensureEnabledDefaults(){
    // Wenn noch nichts gespeichert ist: standardmÃ¤ÃŸig alles freischalten
    if(!localStorage.getItem(LS_ENABLED)){
      ENABLED = new Set(MANIFEST.map(x => x.path));
      saveEnabled();
    }
  }

  function applyEnabledFromCheckboxes(){
    const checks = document.querySelectorAll("#tp_list input[type=checkbox][data-path]");
    ENABLED = new Set([...checks].filter(c => c.checked).map(c => c.getAttribute("data-path")));
    saveEnabled();
  }

  function refreshDropdowns(){
    // Vokabel-Dropdown
    const vSel = document.getElementById("v_thema");
    vSel.innerHTML = "";
    const vok = MANIFEST.filter(x => x.typ === "vokabel" && ENABLED.has(x.path));
    vok.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.path;
      opt.textContent = it.titel;
      vSel.appendChild(opt);
    });

    // Grammatik-Dropdown
    const gSel = document.getElementById("g_thema");
    gSel.innerHTML = "";
    const gram = MANIFEST.filter(x => x.typ === "grammatik" && ENABLED.has(x.path));
    gram.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.path;
      opt.textContent = it.titel;
      gSel.appendChild(opt);
    });
  }

  function useBuiltinManifest(){
    MANIFEST = MANIFEST_BUILTIN.slice();
    localStorage.setItem(LS_MANIFEST_MODE, "builtin");
    ensureEnabledDefaults();
    setStatus("Eingebaute Themen aktiv.");
    renderTeacherList();
    refreshDropdowns();
  }

  function parseManifestCSV(text){
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const out = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      if(i===0 && line.toLowerCase().startsWith("typ")) continue;
      const parts = parseCSVLineSmart(line);
      if(parts.length < 3) continue;
      // Manifest-Format: typ;titel;datei
      out.push({ typ: parts[0], titel: parts[1], source: "remote", path: parts[2] });
    }
    return out;
  }

  async function loadOnlineManifest(){
    setStatus("Lade data/manifest.csv â€¦");
    try{
      const text = await fetchText("data/manifest.csv");
      const parsed = parseManifestCSV(text);

      if(!parsed.length){
        setStatus("manifest.csv geladen, aber leer/Format falsch.");
        return;
      }
      MANIFEST = parsed;
      localStorage.setItem(LS_MANIFEST_MODE, "online");

      // Wenn noch nie freigeschaltet: standardmÃ¤ÃŸig alles freischalten
      if(!localStorage.getItem(LS_ENABLED)){
        ENABLED = new Set(MANIFEST.map(x => x.path));
        saveEnabled();
      }

      setStatus(`Online-Manifest aktiv. (${MANIFEST.length} Themen)`);
      renderTeacherList();
      refreshDropdowns();
    } catch(e){
      setStatus("Konnte manifest.csv nicht laden (noch kein data/Ordner?). Nutze erstmal eingebaute Themen.");
    }
  }

  // Lehrer-Panel Buttons
  document.getElementById("tp_load_online").addEventListener("click", loadOnlineManifest);
  document.getElementById("tp_use_builtin").addEventListener("click", useBuiltinManifest);

  document.getElementById("tp_select_all").addEventListener("click", () => {
    ENABLED = new Set(MANIFEST.map(x => x.path));
    renderTeacherList();
  });
  document.getElementById("tp_select_none").addEventListener("click", () => {
    ENABLED = new Set();
    renderTeacherList();
  });

  document.getElementById("tp_apply").addEventListener("click", () => {
    applyEnabledFromCheckboxes();
    refreshDropdowns();
    alert("Freischaltung gespeichert âœ… (nur auf diesem GerÃ¤t)");
  });

  document.getElementById("tp_reset_storage").addEventListener("click", () => {
    localStorage.removeItem(LS_ENABLED);
    alert("Freischaltung zurÃ¼ckgesetzt. Seite neu laden oder eingebaute Themen aktivieren.");
  });

  document.getElementById("tp_go_home").addEventListener("click", () => showView("home"));

  // -----------------------------
  // Vokabel-CSV Parser + Loader
  // -----------------------------
  function parseVocabText(text){
    // Erwartet: de;en oder de,en (Header optional)
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const out = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      const parts = parseCSVLineSmart(line);
      if(parts.length < 2) continue;

      const first = parts[0].toLowerCase();
      if(i===0 && (first === "de" || first === "deutsch")) continue;

      out.push([parts[0], String(parts[1]).toLowerCase()]);
    }
    return out;
  }

  async function loadVocabByPath(path){
    // path kann builtin:xxx oder data/xxx.csv sein
    if(path.startsWith("builtin:")){
      const key = path.split(":")[1];
      return (BUILTIN[key] || []).map(([d,e]) => [d, String(e).toLowerCase()]);
    }
    // remote csv
    const text = await fetchText(path);
    return parseVocabText(text);
  }

  // -----------------------------
  // Grammar CSV Parser + Loader
  // -----------------------------
  function parseGrammarText(text){
    // Format: frage;richtig;falsch1;falsch2;optional erklÃ¤rung
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const rows = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      const parts = parseCSVLineSmart(line);
      if(parts.length < 4) continue;

      // Header erkennen
      if(i===0 && parts[0].toLowerCase().startsWith("frage")) continue;

      const frage = parts

