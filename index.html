<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sprachlern-App</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; background:#f0f6ff; margin:0; color:#1f2d3d; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1 { margin: 10px 0; }
    .card { background:white; border-radius:18px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; }
    button { font-size: 18px; padding: 12px 14px; border-radius:14px; border:1px solid #d7e3ff; background:#fff; cursor:pointer; }
    button.primary { background:#2d7ff9; color:#fff; border:none; font-weight:800; }
    button.gray { background:#eef3ff; border:1px solid #d7e3ff; font-weight:800; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef3ff; font-weight:700; }
    .hidden { display:none; }
    .q { font-size: 26px; margin: 10px 0 8px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    select, input { font-size: 18px; padding: 10px 12px; border-radius:12px; border:1px solid #d7e3ff; width: min(520px, 100%); }
    .choices { display:flex; gap:12px; flex-wrap:wrap; margin-top: 12px; }
    .choice { background:#4CAF50; color:white; border:none; font-weight:900; min-width: 180px; }
    .choice:disabled { opacity:.6; }
    .feedback { font-size: 20px; font-weight:900; margin-top: 10px; min-height: 28px; }
    .score { margin-top: 6px; font-size: 18px; }
    .hr { height:1px; background:#e8efff; margin: 14px 0; }
    .small { font-size: 14px; opacity:.8; }

    /* Grammatik: feste Buttonfarben */
    .g-yellow { background:#f1c40f !important; color:#1f2d3d !important; }
    .g-blue   { background:#2d7ff9 !important; color:white !important; }
    .g-green  { background:#4CAF50 !important; color:white !important; }

    /* Progressbar */
    .progress {
      width: 100%;
      max-width: 760px;
      height: 14px;
      background: #eef3ff;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #d7e3ff;
      margin-top: 10px;
    }
    .progress > div {
      height: 100%;
      width: 0%;
      background: #2d7ff9;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>ğŸŒ Sprachlern-App</h1>
      <div>
        <span class="pill" id="modePill">Start</span>
        <button class="gray" id="homeBtn" onclick="showView('home')" style="display:none;">ğŸ  Startseite</button>
      </div>
    </div>

    <!-- Lehrer-Panel -->
    <details class="card" style="margin:12px 0; box-shadow:none; border:1px solid #e8efff;">
      <summary style="cursor:pointer; font-weight:900;">ğŸ§‘â€ğŸ« Lehrer-Panel</summary>
      <div style="margin-top:10px;" class="small">
        <ul style="margin-top:6px;">
          <li><strong>Grammatik</strong>: Datei wÃ¤hlen â†’ â€Datei ladenâ€œ â†’ â€Quiz startenâ€œ</li>
          <li><strong>Reset</strong>: lÃ¶scht gespeicherte Grammatik-Datei vom GerÃ¤t</li>
        </ul>
      </div>
      <div class="row">
        <button class="gray" id="resetGrammar">Grammatik-Speicher lÃ¶schen</button>
        <button class="gray" id="goHome">Zur Startseite</button>
      </div>
    </details>

    <!-- HOME -->
    <div id="home" class="card">
      <h2 style="margin-top:0;">WÃ¤hle ein Lernmodul</h2>
      <div class="grid">
        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>ğŸ§  Vokabel-Quiz</h3>
          <p>Multiple Choice, Punkte, Themen.</p>
          <button class="primary" onclick="showView('vocab')">Start</button>
        </div>

        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>ğŸ§© Grammatik-Quiz</h3>
          <p>Import-Datei + ErklÃ¤rung + farbige Buttons.</p>
          <button class="primary" onclick="showView('grammar')">Start</button>
        </div>

        <div class="card" style="box-shadow:none; border:1px solid #e8efff;">
          <h3>âœï¸ LÃ¼ckentext</h3>
          <p>Antworten eintippen (kommagetrennt).</p>
          <button class="primary" onclick="showView('cloze')">Start</button>
        </div>
      </div>
    </div>

    <!-- VOCAB QUIZ -->
    <div id="vocab" class="card hidden">
      <h2 style="margin-top:0;">ğŸ§  Vokabel-Quiz</h2>
      <div class="row">
        <label style="font-size:18px; font-weight:800;">Thema:</label>
        <select id="v_thema"></select>
        <button class="primary" id="v_start">Start / Neustart</button>
      </div>

      <div class="q" id="v_frage">WÃ¤hle ein Thema und klicke Start.</div>
      <div class="progress"><div id="v_prog"></div></div>

      <div class="choices">
        <button class="choice" id="v_b0" disabled>â€”</button>
        <button class="choice" id="v_b1" disabled>â€”</button>
        <button class="choice" id="v_b2" disabled>â€”</button>
      </div>

      <div class="feedback" id="v_feedback"></div>
      <div class="score" id="v_score">Punkte: 0/0</div>
    </div>

    <!-- GRAMMAR QUIZ -->
    <div id="grammar" class="card hidden">
      <h2 style="margin-top:0;">ğŸ§© Grammatik-Quiz</h2>

      <div class="row" style="margin-top:10px;">
        <input id="g_file" type="file" accept=".csv,.txt" />
        <button class="gray" id="g_load">Datei laden</button>
        <button class="primary" id="g_start">Quiz starten</button>
        <span class="small">Format: Frage;richtig;falsch1;falsch2;optional ErklÃ¤rung</span>
      </div>

      <div class="q" id="g_frage">Klicke â€Quiz startenâ€œ (oder lade vorher eine Datei).</div>
      <div class="progress"><div id="g_prog"></div></div>

      <div class="choices">
        <button class="choice g-yellow" id="g_b0" disabled>â€”</button>
        <button class="choice g-blue"  id="g_b1" disabled>â€”</button>
        <button class="choice g-green" id="g_b2" disabled>â€”</button>
      </div>

      <div class="feedback" id="g_feedback"></div>
      <div class="score" id="g_score">Punkte: 0/0</div>

      <div class="card" style="box-shadow:none; border:1px solid #e8efff; background:#fff; margin-top:10px;">
        <div class="small" style="margin-bottom:6px;"><strong>ğŸ’¡ ErklÃ¤rung</strong></div>
        <div id="g_explain" style="font-size:18px; line-height:1.35;">â€”</div>
      </div>
    </div>

    <!-- CLOZE -->
    <div id="cloze" class="card hidden">
      <h2 style="margin-top:0;">âœï¸ LÃ¼ckentext</h2>

      <div class="row">
        <span class="pill">LÃ¼ckentext</span>
        <button class="primary" id="c_new">Neue Aufgabe</button>
        <button class="gray" id="c_check">PrÃ¼fen</button>
      </div>

      <div class="hr"></div>

      <div class="q" id="c_title">Klicke â€Neue Aufgabeâ€œ.</div>

      <div style="margin-top:10px;">
        <div class="small">Text (mit LÃ¼cken als ____):</div>
        <div class="card" style="box-shadow:none; border:1px solid #e8efff; background:#fff;">
          <div id="c_text" style="font-size:22px; line-height:1.4;">â€”</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Deine Einsetzung (kommagetrennt, z. B. â€der, ins, habeâ€œ):</div>
        <input id="c_input" placeholder="Antworten hier eintippenâ€¦" />
      </div>

      <div class="feedback" id="c_feedback"></div>
    </div>
  </div>

<script>
  // Optional: Fehler anzeigen (hilft beim Debuggen)
  // window.onerror = function (msg, url, line, col) {
  //   alert("JavaScript-Fehler:\n" + msg + "\nZeile: " + line + ":" + col);
  //   return false;
  // };

  // -----------------------------
  // NAVIGATION
  // -----------------------------
  function showView(id){
    ["home","vocab","grammar","cloze"].forEach(v => document.getElementById(v).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.getElementById("homeBtn").style.display = (id === "home") ? "none" : "inline-block";
    document.getElementById("modePill").textContent =
      id === "home" ? "Start" :
      id === "vocab" ? "Vokabel-Quiz" :
      id === "grammar" ? "Grammatik-Quiz" : "LÃ¼ckentext";
  }

  // -----------------------------
  // SHARED HELPERS
  // -----------------------------
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }
  function setButtons(btns, disabled){
    btns.forEach(b => b.disabled = disabled);
  }

  // -----------------------------
  // GRAMMAR IMPORT HELPERS
  // -----------------------------
  function parseGrammarText(text){
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
    const rows = [];

    for(const line of lines){
      let parts = line.split(";");
      if(parts.length < 4) parts = line.split(",");
      if(parts.length < 4) parts = line.split("\t");
      if(parts.length < 4) continue;

      const frage  = parts[0].trim();
      const richtig = parts[1].trim();
      const falsch1 = parts[2].trim();
      const falsch2 = parts[3].trim();
      const erklaerung = (parts[4] ?? "").trim();

      rows.push([frage, richtig, falsch1, falsch2, erklaerung]);
    }
    return rows;
  }

  function saveGrammarTable(){
    if (typeof GRAMMAR_TABLE === "undefined") return;
    localStorage.setItem("grammar_table", JSON.stringify(GRAMMAR_TABLE));
  }
  function loadGrammarTable(){
    if (typeof GRAMMAR_TABLE === "undefined") return;
    const raw = localStorage.getItem("grammar_table");
    if(raw){
      try { GRAMMAR_TABLE = JSON.parse(raw); } catch(e) {}
    }
  }

  // =========================================================
  // 1) VOCAB QUIZ
  // =========================================================
  const V_THEMEN = {
    "Tiere": [
      ["Hund","dog"], ["Katze","cat"], ["Vogel","bird"], ["Pferd","horse"], ["Maus","mouse"]
    ],
    "Schule": [
      ["Schule","school"], ["Buch","book"], ["Stift","pen"], ["Tafel","board"], ["Lehrer","teacher"]
    ],
    "Haus": [
      ["Haus","house"], ["TÃ¼r","door"], ["Fenster","window"], ["Tisch","table"], ["Stuhl","chair"]
    ]
  };

  const vSel = document.getElementById("v_thema");
  const vStartBtn = document.getElementById("v_start");
  const vFrage = document.getElementById("v_frage");
  const vFeedback = document.getElementById("v_feedback");
  const vScore = document.getElementById("v_score");
  const vProg = document.getElementById("v_prog");
  const vBtns = [document.getElementById("v_b0"), document.getElementById("v_b1"), document.getElementById("v_b2")];

  let vVok = [];
  let vIndex = 0;
  let vPunkte = 0;
  const vPauseMs = 1500;

  function vMakeOptions(correct){
    const alle = vVok.map(v => v[1]);
    const falsche = alle.filter(w => w !== correct);
    shuffle(falsche);
    const opts = [correct, ...falsche.slice(0, 2)];
    shuffle(opts);
    return opts;
  }

  function vUpdate(){
    vProg.style.width = (vVok.length ? (100 * vIndex / vVok.length) : 0) + "%";
    vFeedback.textContent = "";
    vFeedback.style.color = "#1f2d3d";
    vScore.textContent = `Punkte: ${vPunkte}/${vVok.length}`;

    if(vIndex >= vVok.length){
      vFrage.textContent = "ğŸ Level geschafft!";
      vProg.style.width = "100%";
      const total = vVok.length;
      vFeedback.style.color = "blue";
      if(vPunkte === total) vFeedback.textContent = "ğŸŒŸ Perfekt! Alles richtig!";
      else if(vPunkte > total/2) vFeedback.textContent = "ğŸ‘ Super gemacht!";
      else vFeedback.textContent = "ğŸ’ª Weiter Ã¼ben!";
      vBtns.forEach(b => { b.textContent="â€”"; b.disabled=true; });
      return;
    }

    const [de,en] = vVok[vIndex];
    vFrage.textContent = `Was heiÃŸt â€${de}â€œ auf Englisch?`;
    const opts = vMakeOptions(en);
    opts.forEach((t,i) => { vBtns[i].textContent=t; vBtns[i].disabled=false; });
  }

  function vClick(choice){
    if(vIndex >= vVok.length) return;
    const correct = vVok[vIndex][1];
    setButtons(vBtns,true);

    if(choice === correct){
      vPunkte++;
      vFeedback.style.color = "green";
      vFeedback.textContent = "Richtig! â­ +1 Punkt";
    } else {
      vFeedback.style.color = "#e74c3c";
      vFeedback.textContent = `Falsch. Richtig wÃ¤re: ${correct}`;
    }
    vScore.textContent = `Punkte: ${vPunkte}/${vVok.length}`;
    vIndex++;
    setTimeout(vUpdate, vPauseMs);
  }

  Object.keys(V_THEMEN).forEach(name => {
    const opt = document.createElement("option");
    opt.value=name; opt.textContent=name;
    vSel.appendChild(opt);
  });

  vStartBtn.addEventListener("click", () => {
    vVok = V_THEMEN[vSel.value].map(([d,e]) => [d, String(e).toLowerCase()]);
    shuffle(vVok);
    vIndex = 0; vPunkte = 0;
    vUpdate();
  });

  vBtns.forEach(b => b.addEventListener("click", () => vClick(b.textContent)));

  // =========================================================
  // 2) GRAMMAR QUIZ
  // =========================================================
  const gFile = document.getElementById("g_file");
  const gLoad = document.getElementById("g_load");
  const gStartBtn = document.getElementById("g_start");
  const gFrage = document.getElementById("g_frage");
  const gFeedback = document.getElementById("g_feedback");
  const gScore = document.getElementById("g_score");
  const gExplain = document.getElementById("g_explain");
  const gProg = document.getElementById("g_prog");
  const gBtns = [
    document.getElementById("g_b0"),
    document.getElementById("g_b1"),
    document.getElementById("g_b2")
  ];

  let gItems = [];
  let gIndex = 0;
  let gPunkte = 0;
  const gPauseMs = 1500;

  let gCurrentCorrect = "";
  let gCurrentOptions = [];

  // Fallback-Fragen
  let GRAMMAR_TABLE = [
    ["WÃ¤hle den richtigen Artikel: ___ Hund", "der", "die", "das", "Maskulin: der Hund"],
    ["WÃ¤hle die richtige Form: Ich ___ mÃ¼de.", "bin", "bist", "ist", "1. Person Singular: ich bin"],
    ["WÃ¤hle den richtigen Satz:", "Ich gehe zur Schule.", "Ich gehe Schule.", "Ich gehe in Schule.", "â€zurâ€œ = zu + der (Dativ)"],
  ];
  loadGrammarTable();

  function gPrepareItems(){
    return GRAMMAR_TABLE.map(row => ({
      prompt: row[0],
      correct: row[1],
      wrong: [row[2], row[3]],
      explain: (row[4] ?? "")
    }));
  }

  function gMakeShuffledOptions(item){
    const opts = [item.correct, ...item.wrong];
    shuffle(opts);
    return opts;
  }

  function gUpdate(){
    gProg.style.width = (gItems.length ? (100 * gIndex / gItems.length) : 0) + "%";
    gExplain.textContent = "â€”";

    gFeedback.textContent = "";
    gFeedback.style.color = "#1f2d3d";
    gScore.textContent = `Punkte: ${gPunkte}/${gItems.length}`;

    if(gIndex >= gItems.length){
      gFrage.textContent = "ğŸ Level geschafft!";
      gProg.style.width = "100%";
      const total = gItems.length;
      gFeedback.style.color = "blue";
      if(gPunkte === total) gFeedback.textContent = "ğŸŒŸ Perfekt! Alles richtig!";
      else if(gPunkte > total/2) gFeedback.textContent = "ğŸ‘ Super gemacht!";
      else gFeedback.textContent = "ğŸ’ª Weiter Ã¼ben!";
      gBtns.forEach(b => { b.textContent="â€”"; b.disabled=true; });
      return;
    }

    const item = gItems[gIndex];
    gFrage.textContent = item.prompt;

    gCurrentCorrect = item.correct;
    gCurrentOptions = gMakeShuffledOptions(item);

    gCurrentOptions.forEach((text,i) => {
      gBtns[i].textContent = text;
      gBtns[i].disabled = false;
    });
  }

  function gClick(choice){
    if(gIndex >= gItems.length) return;

    const item = gItems[gIndex];
    setButtons(gBtns,true);

    if(choice === gCurrentCorrect){
      gPunkte++;
      gFeedback.style.color = "green";
      gFeedback.textContent = "Richtig! â­ +1 Punkt";
    } else {
      gFeedback.style.color = "#e74c3c";
      gFeedback.textContent = `Falsch. Richtig wÃ¤re: ${gCurrentCorrect}`;
    }

    if(item.explain && item.explain.trim().length){
      gExplain.textContent = item.explain;
    } else {
      gExplain.textContent = "â€”";
    }

    gScore.textContent = `Punkte: ${gPunkte}/${gItems.length}`;
    gIndex++;
    setTimeout(gUpdate, gPauseMs);
  }

  gBtns.forEach(b => b.addEventListener("click", () => gClick(b.textContent)));

  gLoad.addEventListener("click", async () => {
    const file = gFile.files && gFile.files[0];
    if(!file){
      gFeedback.style.color = "#e74c3c";
      gFeedback.textContent = "Bitte zuerst eine Datei auswÃ¤hlen.";
      return;
    }

    const text = await file.text();
    const table = parseGrammarText(text);

    if(table.length === 0){
      gFeedback.style.color = "#e74c3c";
      gFeedback.textContent = "Datei konnte nicht gelesen werden. PrÃ¼fe: Frage;richtig;falsch1;falsch2;optional ErklÃ¤rung";
      return;
    }

    GRAMMAR_TABLE = table;
    saveGrammarTable();
    gFeedback.style.color = "green";
    gFeedback.textContent = `âœ… ${GRAMMAR_TABLE.length} Fragen geladen!`;
  });

  gStartBtn.addEventListener("click", () => {
    gItems = gPrepareItems();
    shuffle(gItems);
    gIndex = 0;
    gPunkte = 0;
    gUpdate();
  });

  // =========================================================
  // 3) CLOZE
  // =========================================================
  const CLOZE = [
    { title: "Artikel einsetzen", text: "Ich sehe ____ Hund und ____ Katze.", answers: ["einen", "eine"] },
    { title: "PrÃ¤position einsetzen", text: "Ich gehe ____ Schule. (Tipp: zu + der)", answers: ["zur"] }
  ];

  const cNew = document.getElementById("c_new");
  const cCheck = document.getElementById("c_check");
  const cTitle = document.getElementById("c_title");
  const cText = document.getElementById("c_text");
  const cInput = document.getElementById("c_input");
  const cFeedback = document.getElementById("c_feedback");
  let cItem = null;

  function normalize(s){ return String(s).trim().toLowerCase(); }

  function cPick(){
    cItem = CLOZE[Math.floor(Math.random()*CLOZE.length)];
    cTitle.textContent = cItem.title;
    cText.textContent = cItem.text;
    cInput.value = "";
    cFeedback.textContent = "";
    cFeedback.style.color = "#1f2d3d";
  }

  cNew.addEventListener("click", cPick);

  cCheck.addEventListener("click", () => {
    if(!cItem){
      cFeedback.style.color = "#e74c3c";
      cFeedback.textContent = "Bitte zuerst â€Neue Aufgabeâ€œ klicken.";
      return;
    }
    const userParts = cInput.value.split(",").map(normalize).filter(x => x.length);
    const correct = cItem.answers.map(normalize);

    if(userParts.length !== correct.length){
      cFeedback.style.color = "#e74c3c";
      cFeedback.textContent = `Du brauchst ${correct.length} Antwort(en) (kommagetrennt).`;
      return;
    }

    const ok = userParts.every((x,i) => x === correct[i]);
    if(ok){
      cFeedback.style.color = "green";
      cFeedback.textContent = "Richtig! â­";
    } else {
      cFeedback.style.color = "#e74c3c";
      cFeedback.textContent = `Noch nicht. LÃ¶sung: ${cItem.answers.join(", ")}`;
    }
  });

  // Lehrer-Panel Buttons
  document.getElementById("resetGrammar").addEventListener("click", () => {
    localStorage.removeItem("grammar_table");
    alert("Gespeicherte Grammatik-Datei wurde gelÃ¶scht.");
  });
  document.getElementById("goHome").addEventListener("click", () => showView("home"));

  // Start
  showView("home");
</script>
</body>
</html>
